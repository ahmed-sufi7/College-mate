<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDA College 3D Map — 2 floors</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
    #map{position:absolute;inset:0}
    #controls{
      position:absolute;left:12px;top:12px;z-index:3;
      background:#fff;border-radius:8px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,0.12);
      min-width:260px;
    }
    .btn{display:inline-block;padding:8px 10px;margin:3px;border-radius:6px;border:0;cursor:pointer;font-size:13px}
    .btn.primary{background:#0d6efd;color:#fff}
    .btn.ghost{background:#f1f3f5;color:#222}
    input[type="search"]{width:100%;padding:7px;border-radius:6px;border:1px solid #ddd;margin-top:8px}
    #results{max-height:220px;overflow:auto;margin-top:8px}
    .result{padding:8px;border-radius:6px;margin:6px 0;background:#fafafa;cursor:pointer}
    .result:hover{background:#f0f8ff}
    #legend{margin-top:8px;font-size:13px}
    #legend .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .sw{width:18px;height:12px;border-radius:3px;display:inline-block}
  </style>
</head>
<body>
  <div id="controls">
    <div style="display:flex;gap:6px;align-items:center">
      <button id="btnF1" class="btn primary">Floor 1</button>
      <button id="btnF2" class="btn ghost">Floor 2</button>
      <button id="btnBoth" class="btn" style="background:#20c997;color:#fff">Show Both</button>
    </div>

    <input id="search" type="search" placeholder="Search rooms / points (e.g. LH-15, Cloud Computing)" />

    <div id="results"></div>

    <div id="legend">
      <div class="row"><span class="sw" style="background:#1f78b4"></span> Floor 1 (0 → 5 m)</div>
      <div class="row"><span class="sw" style="background:#33a02c"></span> Floor 2 (5 → 10 m)</div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script>
    // -----------------------------
    // Embedded GeoJSONs (from you)
    // -----------------------------
    // map.geojson (points + lines)
    const MAP = {
  "type": "FeatureCollection",
  "features": [
    {"type":"Feature","properties":{"CSD Lab":""},"geometry":{"type":"Point","coordinates":[76.83391874155848,17.315462896635196]}},
    {"type":"Feature","properties":{"Cloud Computing Lab":"C prodraming, Pop, ADA LAB"},"geometry":{"type":"Point","coordinates":[76.8343038892558,17.315541792503822]}},
    {"type":"Feature","properties":{"girls washroom":""},"geometry":{"type":"Point","coordinates":[76.83447184037959,17.315534525551925]}},
    {"type":"Feature","properties":{"stairs to floor 2":""},"geometry":{"type":"Point","coordinates":[76.8344407646942,17.315566970981436]}},
    {"type":"Feature","properties":{"staff room":""},"geometry":{"type":"Point","coordinates":[76.83438517680611,17.315577499373404]}},
    {"type":"Feature","properties":{"library":""},"geometry":{"type":"Point","coordinates":[76.8343521884043,17.315554136068684]}},
    {"type":"Feature","properties":{"staff room 4":""},"geometry":{"type":"Point","coordinates":[76.83423830825348,17.315553806073922]}},
    {"type":"Feature","properties":{"LH-20":""},"geometry":{"type":"Point","coordinates":[76.83411055931043,17.315533322293618]}},
    {"type":"Feature","properties":{"staff room":""},"geometry":{"type":"Point","coordinates":[76.83404571492076,17.315522393099855]}},
    {"type":"Feature","properties":{"HOD Chamber ":""},"geometry":{"type":"Point","coordinates":[76.83399105753745,17.3155215627485]}},
    {"type":"Feature","properties":{"LH-22":""},"geometry":{"type":"Point","coordinates":[76.83391056714981,17.31541795013878]}},
    {"type":"Feature","properties":{"Staff room":""},"geometry":{"type":"Point","coordinates":[76.83392526532685,17.315356635846555]}},
    {"type":"Feature","properties":{"Staff room":""},"geometry":{"type":"Point","coordinates":[76.83395136538121,17.315304617904573]}},
    {"type":"Feature","properties":{"LH-24":""},"geometry":{"type":"Point","coordinates":[76.83393863702605,17.31523776031071]}},
    {"type":"Feature","properties":{"LH 21":""},"geometry":{"type":"Point","coordinates":[76.8338784194508,17.315499676485317]}},
    {"type":"Feature","properties":{"ADE LAB":"ADE lab"},"geometry":{"type":"Point","coordinates":[76.83427605675905,17.31556268873976]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.8340087133198,17.315204836904343],[76.83402722755591,17.315200123515837],[76.83403710181739,17.31518716169741],[76.83404697607745,17.315148276236954],[76.83403833610015,17.315124709287204],[76.83400624475559,17.31510232068129],[76.83402846200005,17.3148890396878],[76.83459376336538,17.31494560043521],[76.83462091758003,17.314940887040066],[76.83462091758003,17.31492674685505],[76.83464807179337,17.31492321180862],[76.83465177464058,17.314877256196667],[76.83462462055286,17.314872542731166],[76.83462708911725,17.314846619046676],[76.83404080495012,17.314775918072172],[76.83393712515925,17.31477572555545],[76.83390626809745,17.31509623642529],[76.83383204624317,17.315099068198634],[76.833821222209,17.31518026008338],[76.83388925899465,17.315195022240246],[76.83384441656688,17.31552126560716]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83398703030338,17.314877635021062],[76.83392874799205,17.314874283278783]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83384379823042,17.31552142639535],[76.8339416200671,17.31552978955048],[76.8339401600407,17.315547909719868],[76.83441758900722,17.315603664074104],[76.83442634917134,17.315584150051762],[76.83444970961114,17.315581362334697],[76.83445116963753,17.31556881760467],[76.83448475026933,17.31556324216865],[76.83449205040557,17.31550470008321],[76.83396936058892,17.315433613239193],[76.83399272102719,17.31520502006599],[76.83401170138342,17.31520502006599]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83442880301925,17.315540173125854],[76.83432182519874,17.315527734264492],[76.83427313657467,17.315520532818383],[76.83425873571412,17.31558600050394]]}},
    {"type":"Feature","properties":{"Seminar Hall":""},"geometry":{"type":"Point","coordinates":[76.83400586761013,17.314841136462775]}},
    {"type":"Feature","properties":{"DSE And Python Lab":""},"geometry":{"type":"Point","coordinates":[76.83534218036664,17.315516178245048]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83453503366553,17.315611528463663],[76.83454772772609,17.315518040844623],[76.8346275189628,17.315528428360608],[76.83461845177777,17.315625378476938],[76.83452777991641,17.315616722218678],[76.83535833415641,17.3157205972918],[76.83538916259056,17.315590753441427],[76.83464021302342,17.315511115833644],[76.83462570552513,17.315524965855317]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83547976015495,17.315564156568428],[76.83540152462047,17.315580494983223],[76.83522549466704,17.31554781815217],[76.83528417131816,17.31504832872868],[76.83548220501609,17.315081005648537],[76.83554088166721,17.315076337517326],[76.8355042087606,17.31528173517073],[76.83532328908598,17.31527473298098],[76.83531280860353,17.315350092625934],[76.8354961731381,17.31536176293578],[76.83548394883587,17.315550821854217]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83412949788368,17.314614861600816],[76.8349363018375,17.314673213377304],[76.83504143083638,17.314645204527224],[76.83503898597644,17.314526166866955],[76.83422484744148,17.31444447430978],[76.83421262313925,17.314477151337044],[76.83413438760482,17.314470149117724],[76.8341221633026,17.314607859386726]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83597820897876,17.31442692814258],[76.83591747483592,17.31409353117239],[76.83596302544248,17.31408386748268],[76.83594278080045,17.313972734848235],[76.83607437144252,17.31394857560828],[76.83608449380012,17.314016221471945],[76.83617053383557,17.314006557779337],[76.83614016676421,17.313909920817025],[76.83635273626413,17.313866434167025],[76.83639828687063,17.314064539932076],[76.83673232465634,17.314011389625122],[76.83675256937141,17.314141849440247],[76.83679305879912,17.31436411409578],[76.83646408219226,17.31440276879151],[76.83613004440662,17.314451087148854],[76.83612498322788,17.31439793695482],[76.8359933925858,17.314417264299593]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83544833141963,17.31479299400806],[76.8355128342775,17.314303433579155],[76.83580309713955,17.314294196577023],[76.83581277256945,17.31419258952731],[76.83552250970581,17.31416487850352],[76.83552250970581,17.31405711337291],[76.8354096297046,17.31405711337291],[76.83537092798957,17.314244932559973],[76.83532900113062,17.314235695554913],[76.8353257759884,17.314303433579155],[76.8353741531318,17.314303433579155],[76.83530965027387,17.314700624215533],[76.83534512684514,17.314712940190333],[76.83533867655899,17.31479915199283],[76.83543543084744,17.31479915199283]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83583534857001,17.314879205772286],[76.83587727542738,17.31460209638547],[76.83601273142926,17.31460209638547],[76.83596112914358,17.314900758707196],[76.8358321234262,17.31486688980864]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83645780013131,17.31478683601739],[76.8369125452835,17.31478683601739],[76.83689964471131,17.315153235749946],[76.8370512264292,17.315143998790532],[76.8370447761431,17.314771441054816],[76.83697704816706,17.314774520046413],[76.83697704816706,17.31470986118967],[76.83691254530919,17.31471909817091],[76.83691254530919,17.31468830823235],[76.83643844929867,17.31469138722653],[76.83642554872807,17.314786836016225],[76.83647392587147,17.314786836016225]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83550135434194,17.315712296312583],[76.83594331499756,17.315741283912757],[76.83604115361771,17.315754167288702],[76.83615923470819,17.315061684537028],[76.83562955667009,17.314981163117338],[76.8355148493244,17.31569297124352],[76.83562620945594,17.315715541773315],[76.83571730058486,17.315081034288497],[76.83604792763953,17.315126126262783],[76.83595683651225,17.31564790402352],[76.83563970443834,17.315618916409406]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83471529817979,17.31497152516029],[76.83472340898373,17.314864478572517],[76.8355904615695,17.314964325191],[76.83556009785991,17.315067392611454],[76.83470991400128,17.314964325191]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83445245692457,17.315567964217422],[76.83446192819372,17.315500496742303]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83442622879375,17.315583266115127],[76.83442914303129,17.31554014258083],[76.83445537116069,17.315541533663136]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83437874288563,17.315534935711582],[76.8343753141097,17.315561777463557],[76.8343622847587,17.315561777463557],[76.83435748447181,17.315595820655076]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83433485454839,17.31552838894163],[76.83432456821924,17.315591892594938]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83426765053372,17.315551302633565],[76.83432868275196,17.315561122786562]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83399314817109,17.315204066674326],[76.83388890905184,17.315195341423575]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83390626760968,17.315093370833083],[76.83396683405726,17.315100524708342]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83403500406007,17.31484862756463],[76.83404200024194,17.314775022969442]]}},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[76.83396382113108,17.315099991230383],[76.83398847914447,17.314878365209594],[76.83399086465596,17.314834793534544]]}}
  ]
};

    // map1.geojson -> floor 2 (top floor)
    const FLOOR2 = {
  "type": "FeatureCollection",
  "features": [
    {"type":"Feature","properties":{"name":"Girls Washroom","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.83448778528061,17.315566523753603],[76.83449353049183,17.31549958742157],[76.83446181230634,17.315493274424156],[76.83445272833951,17.315564991923182],[76.83448778528061,17.315566523753603]]]}},
    {"type":"Feature","properties":{"name":"Stairs","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.83445283409078,17.315580867254766],[76.83446024867747,17.315490025090767],[76.8344235223593,17.315484508950192],[76.83442111590354,17.315580929141987],[76.83445283409078,17.315580867254766]]]}},
    {"type":"Feature","properties":{"name":"LH-18","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.83441955227467,17.315592023313243],[76.83442446279666,17.315485243934447],[76.83433515106508,17.31547574348386],[76.8343252324105,17.315584116593556],[76.83441955227467,17.315592023313243]]]}},
    {"type":"Feature","properties":{"name":"LH-17","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.83432533815534,17.315582460981346],[76.83433525681322,17.315473291010107],[76.8342367165889,17.315464564397885],[76.83423326631538,17.31556887695426],[76.83432533815534,17.315582460981346]]]}},
    {"type":"Feature","properties":{"name":"LH-16","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.83423067090649,17.315567538777813],[76.83423381637094,17.3154678722737],[76.83414748485943,17.31545618653672],[76.8341404768205,17.315556312905457],[76.83423067090649,17.315567538777813]]]}},
    {"type":"Feature","properties":{"name":"LH-15","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.8341378548799,17.315556371628375],[76.83414560198831,17.31545484682735],[76.8340374843114,17.315441478446118],[76.83403173910001,17.315545867272746],[76.8341378548799,17.315556371628375]]]}},
    {"type":"Feature","properties":{"name":"Alumni Office","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.8340318448464,17.31554660223273],[76.8340367553668,17.315444603992944],[76.83397916182251,17.315438290995175],[76.83397425129722,17.315540289240047],[76.8340318448464,17.31554660223273]]]}},
    {"type":"Feature","properties":{"name":"CSD Lab","_source":"auto-extracted","floor":2},"geometry":{"type":"Polygon","coordinates":[[[76.83384278058027,17.315520990451716],[76.83397514145331,17.315546944274317],[76.83398066553785,17.315433237693014],[76.83385044238277,17.315422531392926],[76.83384278058027,17.315520990451716]]]}},
    {"type":"Feature","properties":{"name":"LH-18 (point ref)","geometry":{"type":"Point","coordinates":[76.83437370206173,17.3155331423161]}}}
  ]
};

    // map2.geojson -> floor 1 (ground floor)
    const FLOOR1 = {
  "type": "FeatureCollection",
  "features": [
    {"type":"Feature","properties":{"name":"cyber lab"},"geometry":{"type":"Polygon","coordinates":[[[76.83418299765697,17.315568547923434],[76.83418506273222,17.315461515084195],[76.8342445770208,17.315469568648524],[76.83424457701938,17.31556910216746],[76.83418299765697,17.315568547923434]]]},"id":0},
    {"type":"Feature","properties":{"name":"staff room"},"geometry":{"type":"Polygon","coordinates":[[[76.83410932651026,17.31556087478458],[76.83411470895027,17.31545600484462],[76.83418088542834,17.31546429846962],[76.83417969277923,17.31556406264103],[76.83410932651026,17.31556087478458]]]}},
    {"type":"Feature","properties":{"name":"LH-20"},"geometry":{"type":"Polygon","coordinates":[[[76.83401745696074,17.315550726786512],[76.83402409650239,17.315446719847614],[76.83411002004476,17.315456604325092],[76.83410549324793,17.31555933824177],[76.83401745696074,17.315550726786512]]]}},
    {"type":"Feature","properties":{"name":"staff room"},"geometry":{"type":"Polygon","coordinates":[[[76.83398138884866,17.315543349386587],[76.83398331078774,17.315439756513825],[76.83402038114554,17.31544518526178],[76.83401526759769,17.315542598679528],[76.83398138884866,17.315543349386587]]]}},
    {"type":"Feature","properties":{"name":"LH-21"},"geometry":{"type":"Polygon","coordinates":[[[76.83385406042015,17.315509638982576],[76.83385666235586,17.315471919642476],[76.83393106513284,17.315477907383055],[76.83392758054424,17.315521784410592],[76.83385406042015,17.315509638982576]]]}},
    {"type":"Feature","properties":{"name":"HOD chamber"},"geometry":{"type":"Polygon","coordinates":[[[76.83393309815438,17.315525050961227],[76.83393513489511,17.315476399134795],[76.8339782644378,17.315477326418204],[76.83397737753512,17.315529074377494],[76.83393309815438,17.315525050961227]]]}},
    {"type":"Feature","properties":{"name":"staff room"},"geometry":{"type":"Polygon","coordinates":[[[76.83424872952804,17.315570789281054],[76.83424800044475,17.31546916765292],[76.83429903607055,17.31547403992336],[76.83430000439307,17.315577653969896],[76.83424872952804,17.315570789281054]]]},"id":6},
    {"type":"Feature","properties":{"name":"Cloud Computing Lab"},"geometry":{"type":"Polygon","coordinates":[[[76.83430360861018,17.315580934817547],[76.83430215045053,17.31547652903818],[76.83436558043968,17.315482793386522],[76.83436849675905,17.315587199163474],[76.83430360861018,17.315580934817547]]]},"id":7},
    {"type":"Feature","properties":{"name":"staff room"},"geometry":{"type":"Polygon","coordinates":[[[76.83437029698172,17.315589175573464],[76.83436956790263,17.315482681682596],[76.83441695812292,17.31548824999176],[76.83441841628394,17.315591959726902],[76.83437029698172,17.315589175573464]]]},"id":8},
    {"type":"Feature","properties":{"name":"stairs "},"geometry":{"type":"Polygon","coordinates":[[[76.83442279076576,17.315578734997786],[76.83442060352411,17.315488249992626],[76.83445341213957,17.31549451433976],[76.83445341213957,17.315580823112697],[76.83442279076576,17.315578734997786]]]}},
    {"type":"Feature","properties":{"name":"Girls Washroom"},"geometry":{"type":"Polygon","coordinates":[[[76.83445705754076,17.31557386273002],[76.83445705754076,17.315489642069508],[76.83449424063798,17.315500082649677],[76.83448913707565,17.31557386273002],[76.83445705754076,17.31557386273002]]]}}
  ]
};

    // -----------------------------
    // Utility helpers
    // -----------------------------
    // compute a simple centroid from polygon rings (average of ring coordinates)
    function centroidOfPolygon(poly) {
      // poly: [ [ [lon,lat], ... ] ] (first ring)
      const ring = poly && poly[0] ? poly[0] : [];
      if (!ring.length) return null;
      let sumX = 0, sumY = 0;
      ring.forEach(pt => { sumX += pt[0]; sumY += pt[1]; });
      return [sumX / ring.length, sumY / ring.length];
    }

    // make a point feature for each polygon (for labels & flyTo)
    function polygonCentroidPoints(fc, nameProp = 'name') {
      const pts = { type: 'FeatureCollection', features: [] };
      fc.features.forEach((f, idx) => {
        if (!f.geometry) return;
        if (f.geometry.type !== 'Polygon') return;
        const c = centroidOfPolygon(f.geometry.coordinates);
        const label = (f.properties && (f.properties[nameProp] || f.properties.label || f.properties.name)) || ('room-' + idx);
        pts.features.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: c },
          properties: { label, source_index: idx, original_props: f.properties || {} }
        });
      });
      return pts;
    }

    // Merge polygon features into a single geojson (and ensure each has a 'height' & 'floor' property)
    function prepareFloorPolys(fc, floorNumber) {
      const out = { type: 'FeatureCollection', features: [] };
      (fc.features || []).forEach(f => {
        const clone = JSON.parse(JSON.stringify(f));
        if (!clone.properties) clone.properties = {};
        // set uniform heights (Option A)
        if (floorNumber === 1) {
          clone.properties.floor = 1;
          clone.properties.height = 5;         // top
          clone.properties.base = 0;           // base
        } else {
          clone.properties.floor = 2;
          clone.properties.height = 10;        // top
          clone.properties.base = 5;           // base
        }
        out.features.push(clone);
      });
      return out;
    }

    // -----------------------------
    // Map initialization
    // -----------------------------
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          'osm-tiles': {
            type: 'raster',
            tiles: [
              'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            tileSize: 256
          }
        },
        layers: [{ id: 'osm-tiles', type: 'raster', source: 'osm-tiles' }]
      },
      center: [76.8342, 17.3154],
      zoom: 18,
      pitch: 60,
      bearing: -20
    });

    map.on('load', () => {
      // prepare floor GeoJSONs
      const floor1Polys = prepareFloorPolys(FLOOR1, 1);
      const floor2Polys = prepareFloorPolys(FLOOR2, 2);

      // polygon centroids for labels
      const floor1Points = polygonCentroidPoints(floor1Polys);
      const floor2Points = polygonCentroidPoints(floor2Polys);

      // add sources
      map.addSource('map-points', { type: 'geojson', data: MAP }); // raw points + lines
      map.addSource('floor1-polys', { type: 'geojson', data: floor1Polys });
      map.addSource('floor2-polys', { type: 'geojson', data: floor2Polys });
      map.addSource('floor1-points', { type: 'geojson', data: floor1Points });
      map.addSource('floor2-points', { type: 'geojson', data: floor2Points });

      // add outline lines from MAP (LineString features)
      map.addLayer({
        id: 'outlines',
        type: 'line',
        source: 'map-points',
        filter: ['==', ['geometry-type'], 'LineString'],
        paint: { 'line-color': '#003f7f', 'line-width': 2, 'line-opacity': 0.9 }
      });

      // Floor 1 extrusions
      map.addLayer({
        id: 'floor1-extrude',
        type: 'fill-extrusion',
        source: 'floor1-polys',
        paint: {
          'fill-extrusion-color': '#1f78b4',
          'fill-extrusion-height': ['get', 'height'],
          'fill-extrusion-base': ['get', 'base'],
          'fill-extrusion-opacity': 0.95
        }
      });

      // Floor 2 extrusions (hidden initially)
      map.addLayer({
        id: 'floor2-extrude',
        type: 'fill-extrusion',
        source: 'floor2-polys',
        layout: { visibility: 'none' },
        paint: {
          'fill-extrusion-color': '#33a02c',
          'fill-extrusion-height': ['get', 'height'],
          'fill-extrusion-base': ['get', 'base'],
          'fill-extrusion-opacity': 0.95
        }
      });

      // labels for floor1 (from centroid points)
      map.addLayer({
        id: 'floor1-labels',
        type: 'symbol',
        source: 'floor1-points',
        layout: {
          'text-field': ['coalesce', ['get', 'label'], ''],
          'text-size': 12,
          'text-anchor': 'top',
          'text-offset': [0, 1.0]
        },
        paint: { 'text-color': '#fff', 'text-halo-color': '#000', 'text-halo-width': 1 }
      });

      // labels for floor2 (hidden initially)
      map.addLayer({
        id: 'floor2-labels',
        type: 'symbol',
        source: 'floor2-points',
        layout: { 'text-field': ['coalesce', ['get', 'label'], ''], 'text-size': 12, 'text-anchor': 'top', 'text-offset':[0,1.0] },
        paint: { 'text-color': '#fff', 'text-halo-color': '#000', 'text-halo-width': 1 },
        layout: { visibility: 'none' } // ensure labels hidden with floor
      });

      // points from MAP (original loose POIs)
      map.addLayer({
        id: 'map-poi-points',
        type: 'circle',
        source: 'map-points',
        filter: ['==', ['geometry-type'], 'Point'],
        paint: { 'circle-radius': 5, 'circle-color': '#ff7f00', 'circle-stroke-color': '#fff', 'circle-stroke-width': 1.5 }
      });

      // clickable highlight layer (single feature highlight)
      map.addSource('hover-highlight', { type: 'geojson', data: { type:'FeatureCollection', features:[] } });
      map.addLayer({
        id: 'hover-highlight-fill',
        type: 'line',
        source: 'hover-highlight',
        paint: { 'line-color': '#ff0000', 'line-width': 3 }
      });

      // bind interactivity: clicking on extrusions shows popup
      map.on('click', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['floor1-extrude','floor2-extrude','map-poi-points'] });
        if (!features || !features.length) return;
        const f = features[0];
        let coords, title;
        if (f.layer.id === 'map-poi-points') {
          coords = f.geometry.coordinates;
          // derive title from properties (first key/value pair)
          const p = f.properties || {};
          title = Object.keys(p).length ? (Object.keys(p)[0] + (p[Object.keys(p)[0]] ? ': ' + p[Object.keys(p)[0]] : '')) : 'Point';
        } else {
          // polygon feature -> get centroid to anchor popup
          coords = centroidOfPolygon(f.geometry.coordinates) || e.lngLat;
          title = (f.properties && (f.properties.name || f.properties.label || ('Room'))) || 'Room';
        }
        // popup
        new maplibregl.Popup({ offset: [0,-10] })
          .setLngLat(coords)
          .setHTML('<strong>' + title + '</strong>')
          .addTo(map);

        // highlight polygon boundary briefly
        const geom = (f.layer.id === 'map-poi-points') ? null : { type:'Feature', geometry: f.geometry, properties:{} };
        if (geom) {
          map.getSource('hover-highlight').setData({ type:'FeatureCollection', features:[geom] });
          // clear after 3s
          setTimeout(()=>{ map.getSource('hover-highlight').setData({ type:'FeatureCollection', features:[] }); }, 3000);
        }
      });

      // change cursor to pointer when hovering clickable layers
      ['floor1-extrude','floor2-extrude','map-poi-points'].forEach(layerId => {
        map.on('mouseenter', layerId, () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', layerId, () => map.getCanvas().style.cursor = '');
      });

      // Fit to building area (compute bbox of all polygon coordinates)
      try {
        const allCoords = [];
        [floor1Polys, floor2Polys, MAP].forEach(fc => {
          (fc.features||[]).forEach(f => {
            if (!f.geometry) return;
            if (f.geometry.type === 'Polygon') {
              (f.geometry.coordinates[0]||[]).forEach(c => allCoords.push(c));
            } else if (f.geometry.type === 'Point') {
              allCoords.push(f.geometry.coordinates);
            } else if (f.geometry.type === 'LineString') {
              (f.geometry.coordinates||[]).forEach(c => allCoords.push(c));
            }
          });
        });
        if (allCoords.length) {
          let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
          allCoords.forEach(c => { const x=c[0], y=c[1]; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
          map.fitBounds([[minX,minY],[maxX,maxY]], { padding:80, maxZoom:19, duration:1200 });
        }
      } catch(e){ console.warn('fitBounds failed', e); }

      // expose for search
      window._MAP_GEO = { mapPoints: MAP, floor1Polys, floor2Polys, floor1Points, floor2Points };

    }); // map.on('load')

    // -----------------------------
    // UI bindings: floor toggles
    // -----------------------------
    document.getElementById('btnF1').addEventListener('click', () => {
      if (!map) return;
      if (map.getLayer('floor1-extrude')) map.setLayoutProperty('floor1-extrude','visibility','visible');
      if (map.getLayer('floor1-labels')) map.setLayoutProperty('floor1-labels','visibility','visible');
      if (map.getLayer('floor2-extrude')) map.setLayoutProperty('floor2-extrude','visibility','none');
      if (map.getLayer('floor2-labels')) map.setLayoutProperty('floor2-labels','visibility','none');
    });
    document.getElementById('btnF2').addEventListener('click', () => {
      if (!map) return;
      if (map.getLayer('floor1-extrude')) map.setLayoutProperty('floor1-extrude','visibility','none');
      if (map.getLayer('floor1-labels')) map.setLayoutProperty('floor1-labels','visibility','none');
      if (map.getLayer('floor2-extrude')) map.setLayoutProperty('floor2-extrude','visibility','visible');
      if (map.getLayer('floor2-labels')) map.setLayoutProperty('floor2-labels','visibility','visible');
    });
    document.getElementById('btnBoth').addEventListener('click', () => {
      if (!map) return;
      if (map.getLayer('floor1-extrude')) map.setLayoutProperty('floor1-extrude','visibility','visible');
      if (map.getLayer('floor1-labels')) map.setLayoutProperty('floor1-labels','visibility','visible');
      if (map.getLayer('floor2-extrude')) map.setLayoutProperty('floor2-extrude','visibility','visible');
      if (map.getLayer('floor2-labels')) map.setLayoutProperty('floor2-labels','visibility','visible');
    });

    // -----------------------------
    // Search
    // -----------------------------
    const searchInput = document.getElementById('search');
    const resultsDiv = document.getElementById('results');

    function clearResults() { resultsDiv.innerHTML = ''; }

    function addResultItem(title, coords, snippet) {
      const d = document.createElement('div');
      d.className = 'result';
      d.innerHTML = '<strong>' + title + '</strong>' + (snippet ? '<div style="color:#555;font-size:12px;margin-top:4px;">' + snippet + '</div>' : '');
      d.onclick = () => {
        map.flyTo({ center: coords, zoom: 19, duration: 800 });
        new maplibregl.Popup({ offset:[0,-12] }).setLngLat(coords).setHTML('<b>' + title + '</b>' + (snippet?'<br>' + snippet:'')).addTo(map);
      };
      resultsDiv.appendChild(d);
    }

    function searchQuery(q) {
      q = (q||'').trim().toLowerCase();
      clearResults();
      if (!q) return;
      // Search points in MAP
      (window._MAP_GEO.mapPoints.features || []).forEach(f => {
        if (!f.properties || !f.geometry) return;
        if (f.geometry.type !== 'Point') return;
        const text = JSON.stringify(f.properties).toLowerCase();
        if (text.indexOf(q) !== -1) {
          const title = Object.keys(f.properties)[0] || f.properties.name || 'Point';
          addResultItem(title, f.geometry.coordinates, JSON.stringify(f.properties));
        }
      });
      // Search floor polygons (floor1 and floor2)
      ['floor1Polys','floor2Polys'].forEach(sourceKey => {
        const fc = window._MAP_GEO && window._MAP_GEO[sourceKey];
        if (!fc) return;
        (fc.features || []).forEach(f => {
          const name = (f.properties && (f.properties.name || f.properties.label)) || '';
          if (name && name.toLowerCase().indexOf(q) !== -1) {
            const c = centroidOfPolygon(f.geometry.coordinates);
            addResultItem(name, c, 'Floor: ' + (f.properties.floor || (sourceKey === 'floor2Polys' ? 2 : 1)));
          }
        });
      });
      // if no results show message
      if (!resultsDiv.children.length) {
        resultsDiv.innerHTML = '<div style="padding:8px;color:#666">No results</div>';
      }
    }

    let debounceTimer = null;
    searchInput.addEventListener('input', (e) => {
      const v = e.target.value;
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>searchQuery(v), 200);
    });

    // pre-populate: show floor 1 by default
    document.getElementById('btnF1').click();

  </script>
</body>
</html>
